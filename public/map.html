<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore.js"></script>
  <script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Safe Eats</title>


</head>
<body>
        <header>
            <h1 style="font-size:500%";>SAFE <span style="color:#ff7e67";>EATS</span></h1>
                <h1></h1>
                </header>

      <!-- NAVIGATION BAR -->
      <nav>
            <ul>
                    <a href="index.html" style="color:#4D4D4D; font-weight: bold";><li>Home</li></a>
                    <a href="home.html" style="color:#4D4D4D; font-weight: bold";><li>App</li></a>
                    <a href="about.html" style="color:#4D4D4D; font-weight: bold";><li>About</li></a>
                    <a href="documentation.html" style="color:#4D4D4D; font-weight: bold";><li>Documentation</li></a>
                    <a href="map.html" style="color:#4D4D4D; font-weight: bold";><li>Map</li></a>
                  </ul>

          <div class="handle">
            <p class="menu">Menu</p>
            <div class="menu_icon">
                <div></div>
                <div></div>
                <div></div>
              </div>
          </div>
        </nav>
        
        <script>
            $('.handle').on('click', function(){
              $('nav ul').toggleClass('showing');
            });

        </script>

  <!--Loading the data from the PG County Dataset using server.js-->
  <script>
    // let total = new Array();
    // let names = new Array();
    // let categories = new Array();
    // let results = new Array();
    // let locations = new Array();
    // console.log("fetch"); // confirm code is running on click
    // fetch("/api")
    // .then(res => res.json())
    // .then(res => {
    //   return res;
    // })
    // .then(res => res.data.map(c => c))
    // .then(res => {
    //   console.log(res.length);
    //   for(let x = 0; x < res.length; x++){
    //     names.push(res[x].name);
    //     categories.push(res[x].category);
    //     results.push(res[x].inspection_results);
    //     locations.push(res[x].geocoded_column_1);
    //   }
    //   total.push(res); //total[0] is res
    //   total.push(names); //total[1] is names
    //   total.push(categories); //total[2] is categories
    //   total.push(results); //total[3] is results
    //   total.push(locations);
    //   console.log(locations[0].coordinates);
    //   return total; 
    // });

    let total = new Array();
        let names = new Array();
        let categories = new Array();
        let results = new Array();
        let locations = new Array();

    
      console.log("fetch"); // confirm code is running on click
        fetch("/api")
        .then(res => res.json())
        .then(res => {
          return res;
        }) 
    .then(res => res.data.map(c => c))
    .then(res => {
          console.log(res.length);
          for(let x = 0; x < res.length; x++){
            names.push(res[x].name);
            categories.push(res[x].category);
            results.push(res[x].inspection_results);
            locations.push(res[x].geocoded_column_1);
          }
          total.push(res); //total[0] is res
          total.push(names); //total[1] is names
          total.push(categories); //total[2] is categories
          total.push(results); //total[3] is results
          total.push(locations);
          return total; 
        });

      let data = [];

        $.ajax({
          dataType: "json",
          url: 'https://data.princegeorgescountymd.gov/resource/umjn-t2iz.json',
          success: handleResponse
        });
        function handleClick(i) {
          console.log(data[i]);

          let lat = data[i].geocoded_column_1.coordinates[0];
          let lng = data[i].geocoded_column_1.coordinates[1];

      var center = new google.maps.LatLng(lat, lng);
       // var map = document.getElementById("map");
       map.panTo(center);
      var marker = new google.maps.Marker({
        position: center,
        map: map,
        title: 'Location'
      });
        }
      function handleResponse(res) {
          data = res;
          for(let i = 0; i < res.length; i++) {
            let list_item = '<div class="list-group-item list-group-item-action" onclick="handleClick('+i+')">'+res[i].name+'</div>';
            $('#list_group').append(list_item);
          }
        }

      var map, infoWindow;
    function initMap() {
      var mapOptions = {
        center: {Lat: 43.654, Lng: -79.383},
        zoom: 10,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };
      map = new google.maps.Map(document.getElementById("map"),
          mapOptions);
      var input = document.getElementById('Search');
      var SearchBox = new google.maps.places.SearchBox(input);
      map.addListner('bounds_changed', function()
       {
        SearchBox.SetBounds(map.getBounds());
      })
      var markers = [];
      searchBox.addListener('places_changed', function()
      {
          var places=searchBox.getPlaces();
          if(places.length===0)
          return;

          markers.forEach(function (m) {m.setMap(null); });
          markers = [];

          var bounds=new.google.maps.LatLngBounds();
          places.forEach(function(p)
          {
            if(!p.geometry)
            return;
            markers.push(new google.maps.Marker({
              map: map,
              title: p.name, 
              position: p.geometry.location
            }));
          if (p.geometry.viewport)
        bounds.union(p.geometry.viewport);
      else
        bounds.extend(p.geometry.location);  
          });
          map.fitBounds(bounds);
      });

      
      

      infoWindow = new google.maps.infoWindow;
      if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (p) {
      var position = {
        lat: p.coords.latitude,
        lng: p.coords.longitude
      };

      infoWindow.setPosition(position);
      infoWindow.setContent('Your location!');
      infoWindow.open(map);
      map.setCenter(position);
    }, function () {
      handleLocationError('Geolocation service failed', map.getCenter());
    });
  } else {
    handleLocationError('No geolocation available.', map.getCenter());
  }
}

function handleLocationError (content, position) {
  infoWindow.setPosition(position);
  infoWindow.setContent(content);
  infoWindow.open(map);   
    }
    </script>

<br>


<div class="container">
<div class="wrapper">

  <!--Making the form for a list of category filters-->
  <div class ='row'>
  <div class='column'>
  <form id="make_checkbox_select">
    <select name="Search">
        <option value="Bakery">Bakery</option>
        <option value="Bar/Tavern/Lounge">Bar/Tavern/Lounge</option>
        <option value="Carry-out">Carry-out</option>
        <option value="Casino">Casino</option>
        <option value="Coffee Shop">Coffee Shop</option>
        <option value="Convenience Store">Convenience Store</option>
        <option value="Deli">Deli</option>
        <option value="Diner">Diner</option>
        <option value="Farmer's Market">Farmer's Market</option>
        <option value="Fast Food">Fast Food</option>
        <option value="Gas Station Store">Gas Station Store</option>
        <option value="Grocery Store">Grocery Store</option>
        <option value="Ice Cream">Ice Cream</option>
        <option value="Meat/Poultry Market">Meat/Poultry Market</option>
        <option value="Micro Market">Micro Market</option>
        <option value="Night Club">Night Club</option>
        <option value="Pizza">Pizza</option>
        <option value="Private Club">Private Club</option>
        <option value="Private School">Private School</option>
        <option value="Restaurant">Restaurant</option>
        <option value="Seafood">Seafood</option>
    </select>
    <input type="submit" />
  </form>
  <br>
  <div id="content">
      <div class="list-group" id="list_group">
          
        </div>
  </div> 
  <br>
</div>

<div class ='row mb-2'>
  <div class = 'column'>
    <input class = 'form-control' id='search' type='text' placeholder='Search...'/> >
  </div>
</div>

<!-- MAP -->
<div class='column'>
    <div class="mapouter">
        <div id="map">
          
        </div>
      </div>
    </div>
</div>
</div>

<script async defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA1dhqrdCy1oDakQU22tjcE4El8vG8cokg&callback=initMap&libraries=places">
</script>



  <!--Starting script to filter the data-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script>
    $(function()
    {
      var mySelectCheckbox = new checkbox_select(
      {
        selector : "#make_checkbox_select",
              selected_translation : "selected",
              all_translation : "Select All",
              not_found : "Not Found",
  
        //Actual function that displayes the filtered lists based on category
        onApply : function(e)
        {
                let old_test = document.querySelector("#content");
                old_test.innerHTML = "";

                for(let i = 0; i < e.selected.length; i++){
                  let search_results = document.createElement('ul');
                  search_results.style.listStyleType = 'none';
                  let results_head = document.createElement("H2");
                  let head_item = document.createTextNode(e.selected[i]);
                  results_head.appendChild(head_item);
                  old_test.append(results_head);

                  for(let x = 0; x < categories.length; x++){
                    if(categories[x] == e.selected[i]){ 
                      if(results[x] != "Non-Compliant - Violations Observed" ||
                      results[x] != "Compliance Schedule - Outstanding" || 
                      results[x] != "Complaint - Health Risk" || 
                      results[x] != "------" ||
                      results[x] != "Critical Violations observed" || 
                      results[x] != "Facility Closed"){
                        let search_item = document.createElement('li'); 
                        search_item.appendChild(document.createTextNode(names[x]));
                        search_results.appendChild(search_item);
                    }
                  }
                }
                if(!search_results.hasChildNodes()){
                  old_test.append(document.createTextNode("NO RESULTS"));
                }
                old_test.append(search_results);
              }
              }
            });        
          });
          </script>


  <div class="footer"></div>
</div>
</div>

<!--Separate file that works with the form to filter for the selected options-->
<script src="filter.js"></script>

</body>

</html> 

